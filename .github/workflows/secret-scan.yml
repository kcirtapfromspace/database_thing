# Secret Scanning Workflow
# Dedicated workflow for detecting secrets in PRs and pushes
# Uses Gitleaks with project-specific configuration

name: Secret Scan

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    # Run weekly full scan on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      full_scan:
        description: 'Run full repository scan'
        required: false
        default: 'false'
        type: boolean

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (PR scan)
        if: github.event_name == 'pull_request'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

      - name: Run Gitleaks (full scan)
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.full_scan == 'true')
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: true
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Run Gitleaks (push scan)
        if: github.event_name == 'push'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  trufflehog:
    name: TruffleHog Deep Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.full_scan == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog scan
        uses: trufflesecurity/trufflehog@v3.82.6
        with:
          extra_args: --only-verified --json

  env-file-check:
    name: Environment File Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for committed .env files
        run: |
          # Check for .env files that shouldn't be committed
          ENV_FILES=$(find . -name '.env' -o -name '.env.local' -o -name '.env.*.local' | grep -v node_modules | grep -v .venv || true)

          if [ -n "$ENV_FILES" ]; then
            echo "::error::Found .env files that should not be committed:"
            echo "$ENV_FILES"
            echo ""
            echo "Please add these files to .gitignore and remove them from the repository."
            exit 1
          fi

          echo "No problematic .env files found"

      - name: Check for hardcoded credentials patterns
        run: |
          # Check for common hardcoded credential patterns
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "secret_key\s*=\s*['\"][^'\"]+['\"]"
            "AWS_SECRET_ACCESS_KEY\s*=\s*['\"][^'\"]+['\"]"
          )

          FOUND_ISSUES=0

          for pattern in "${PATTERNS[@]}"; do
            # Search Python files, excluding examples and tests
            MATCHES=$(grep -rn --include="*.py" -E "$pattern" . 2>/dev/null | \
              grep -v "\.example" | \
              grep -v "test_" | \
              grep -v "_test\.py" | \
              grep -v "os\.getenv" | \
              grep -v "os\.environ" | \
              grep -v "#" || true)

            if [ -n "$MATCHES" ]; then
              echo "::warning::Potential hardcoded credentials found:"
              echo "$MATCHES"
              FOUND_ISSUES=1
            fi
          done

          if [ "$FOUND_ISSUES" -eq 1 ]; then
            echo ""
            echo "Please use environment variables instead of hardcoded credentials."
            echo "Example: password = os.getenv('DB_PASSWORD')"
          fi

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, env-file-check]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.gitleaks.result }}" == "failure" ] || [ "${{ needs.env-file-check.result }}" == "failure" ]; then
            echo "::error::Security scan failed. Please review and fix the issues above."
            exit 1
          fi
          echo "All security scans passed!"
